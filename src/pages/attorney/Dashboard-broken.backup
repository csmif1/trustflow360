import React, { useEffect, useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Progress } from '@/components/ui/progress';
import PremiumDashboard from "@/components/PremiumDashboard";
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { 
  AlertTriangle, 
  FileText, 
  DollarSign, 
  TrendingUp, 
  Clock, 
  Upload,
  Mail,
  Calculator,
  Users,
  PlusCircle,
  FileUp
} from 'lucide-react';
import { useNavigate } from 'react-router-dom';

interface DashboardStats {
  totalTrusts: number;
  pendingNotices: number;
  ytdGifts: number;
  complianceScore: number;
}

interface ComplianceAlert {
  id: string;
  type: 'high' | 'medium' | 'low';
  message: string;
  action?: string;
}

interface QuickAction {
  title: string;
  description: string;
  icon: React.ReactNode;
  features: string[];
  action: string;
  onClick: () => void;
}

interface UpcomingPremium {
  id: string;
  policyNumber: string;
  company: string;
  trustName: string;
  amount: number;
  dueDate: string;
  daysUntilDue: number;
}

const Dashboard: React.FC = () => {
  const navigate = useNavigate();
  const [stats, setStats] = useState<DashboardStats>({
    totalTrusts: 0,
    pendingNotices: 0,
    ytdGifts: 0,
    complianceScore: 0
  });
  const [complianceAlerts, setComplianceAlerts] = useState<ComplianceAlert[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('quick-actions');
  const [selectedTrustId, setSelectedTrustId] = useState<string | null>(null);
  const [trusts, setTrusts] = useState<any[]>([]);
  const [upcomingPremiums, setUpcomingPremiums] = useState<UpcomingPremium[]>([]);

  useEffect(() => {
    fetchDashboardData();
  }, []);

  const fetchDashboardData = async () => {
    try {
      // Fetch trust count
      const { count: trustCount } = await supabase
        .from('trusts')
        .select('*', { count: 'exact', head: true });

      // Fetch actual trusts for selection
      const { data: trustsData } = await supabase
        .from('trusts')
        .select('id, name, trust_type')
        .order('created_at', { ascending: false });

      if (trustsData) {
        setTrusts(trustsData);
        // Auto-select first trust if none selected
        if (trustsData.length > 0 && !selectedTrustId) {
          setSelectedTrustId(trustsData[0].id);
        }
      }

      // Fetch pending notices count
      const { count: noticeCount } = await supabase
        .from('crummey_notices')
        .select('*', { count: 'exact', head: true })
        .eq('status', 'pending');

      // Fetch YTD gifts
      const currentYear = new Date().getFullYear();
      const { data: giftsData } = await supabase
        .from('gifts')
        .select('amount')
        .gte('gift_date', `${currentYear}-01-01`);

      const ytdGifts = giftsData?.reduce((sum, gift) => sum + gift.amount, 0) || 0;

      // Calculate compliance score
      const complianceScore = calculateComplianceScore(trustCount || 0, noticeCount || 0);

      setStats({
        totalTrusts: trustCount || 0,
        pendingNotices: noticeCount || 0,
        ytdGifts,
        complianceScore
      });

      // Set compliance alerts based on data
      const alerts: ComplianceAlert[] = [];
      if (noticeCount && noticeCount > 0) {
        alerts.push({
          id: '1',
          type: 'high',
          message: `${noticeCount} Crummey notices pending delivery`,
          action: 'Review and send notices'
        });
      }

      setComplianceAlerts(alerts);
    } catch (error) {
      console.error('Error fetching dashboard data:', error);
    } finally {
      setLoading(false);
    }
  };

  const calculateComplianceScore = (trusts: number, pendingNotices: number): number => {
    if (trusts === 0) return 100;
    const noticeRatio = pendingNotices / trusts;
    if (noticeRatio === 0) return 100;
    if (noticeRatio < 0.1) return 90;
    if (noticeRatio < 0.2) return 75;
    if (noticeRatio < 0.5) return 50;
    return 25;
  };

  const quickActions: QuickAction[] = [
    {
      title: 'Upload Gift Letter',
      description: 'Process gift documentation with AI extraction',
      icon: <Upload className="h-5 w-5" />,
      features: ['AI-powered data extraction', 'Automatic Crummey notice generation'],
      action: 'Upload Document',
      onClick: () => navigate('/documents/upload')
    },
    {
      title: 'Record Gift Manually',
      description: 'Enter gift details directly',
      icon: <DollarSign className="h-5 w-5" />,
      features: ['Quick entry form', 'Auto-calculate beneficiary shares'],
      action: 'Enter Gift Details',
      onClick: () => navigate('/gifts/new')
    },
    {
      title: 'Send Crummey Notices',
      description: `${stats.pendingNotices} notices pending`,
      icon: <Mail className="h-5 w-5" />,
      features: ['DocuSign & Adobe Sign ready', 'Physical mail tracking'],
      action: 'Review & Send',
      onClick: () => navigate('/notices')
    }
  ];

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-slate-900 mb-2">
            ILIT Management Dashboard
          </h1>
          <p className="text-slate-600">Comprehensive trust administration with AI-powered compliance</p>
        </div>

        {/* Premium Management Dashboard with Trust Selection */}
        <div className="mb-8">
          {trusts.length > 0 ? (
            <>
              <div className="mb-4 flex items-center justify-between">
                <h2 className="text-xl font-semibold">Premium Dashboard</h2>
                <Select value={selectedTrustId || ''} onValueChange={setSelectedTrustId}>
                  <SelectTrigger className="w-[300px]">
                    <SelectValue placeholder="Select a trust" />
                  </SelectTrigger>
                  <SelectContent>
                    {trusts.map((trust) => (
                      <SelectItem key={trust.id} value={trust.id}>
                        {trust.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              {selectedTrustId && <PremiumDashboard trustId={selectedTrustId} />}
            </>
          ) : (
            <Card>
              <CardContent className="py-8 text-center text-muted-foreground">
                No trusts found. Create a trust to view premium management.
              </CardContent>
            </Card>
          )}
        </div>

        {/* Compliance Alerts */}
        {complianceAlerts.length > 0 && (
          <div className="mb-6">
            <Alert className="border-orange-200 bg-orange-50">
              <AlertTriangle className="h-4 w-4 text-orange-600" />
              <AlertTitle>Compliance Alerts</AlertTitle>
              <AlertDescription>
                {complianceAlerts.map(alert => (
                  <div key={alert.id} className="flex items-center justify-between">
                    <span>{alert.message}</span>
                    {alert.action && (
                      <Button 
                        size="sm" 
                        variant="link" 
                        className="text-orange-700"
                        onClick={() => navigate('/notices')}
                      >
                        {alert.action}
                      </Button>
                    )}
                  </div>
                ))}
              </AlertDescription>
            </Alert>
          </div>
        )}

        {/* Stats Overview */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-slate-600">Active Trusts</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{stats.totalTrusts}</div>
              <p className="text-xs text-slate-500">Managed ILITs</p>
            </CardContent>
          </Card>

          <Card className="border-orange-200">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-slate-600">Pending Notices</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-orange-600">{stats.pendingNotices}</div>
              <p className="text-xs text-slate-500">Awaiting delivery</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-slate-600">YTD Gifts</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">${(stats.ytdGifts / 1000).toFixed(0)}k</div>
              <p className="text-xs text-slate-500">Total contributions</p>
            </CardContent>
          </Card>

          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm font-medium text-slate-600">Compliance Score</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">{stats.complianceScore}%</div>
              <Progress value={stats.complianceScore} className="mt-2" />
            </CardContent>
          </Card>
        </div>

        {/* Main Content Tabs */}
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-4">
          <TabsList className="grid w-full grid-cols-4">
            <TabsTrigger value="quick-actions">Quick Actions</TabsTrigger>
            <TabsTrigger value="trusts">Trusts</TabsTrigger>
            <TabsTrigger value="documents">Documents</TabsTrigger>
            <TabsTrigger value="compliance">Compliance</TabsTrigger>
          </TabsList>

          <TabsContent value="quick-actions" className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {quickActions.map((action, index) => (
                <Card key={index} className="cursor-pointer hover:shadow-lg transition-shadow">
                  <CardHeader>
                    <div className="flex items-center space-x-3">
                      <div className="p-2 bg-primary/10 rounded-lg">
                        {action.icon}
                      </div>
                      <CardTitle className="text-lg">{action.title}</CardTitle>
                    </div>
                    <CardDescription>{action.description}</CardDescription>
                  </CardHeader>
                  <CardContent>
                    <ul className="space-y-2 mb-4">
                      {action.features.map((feature, idx) => (
                        <li key={idx} className="flex items-center text-sm text-slate-600">
                          <div className="w-1.5 h-1.5 bg-primary rounded-full mr-2" />
                          {feature}
                        </li>
                      ))}
                    </ul>
                    <Button 
                      className="w-full" 
                      onClick={action.onClick}
                    >
                      {action.action}
                    </Button>
                  </CardContent>
                </Card>
              ))}
            </div>

            {/* Add Trust Button */}
            <Card className="border-dashed">
              <CardContent className="flex flex-col items-center justify-center py-8">
                <PlusCircle className="h-12 w-12 text-slate-400 mb-4" />
                <h3 className="text-lg font-semibold mb-2">Create New ILIT</h3>
                <p className="text-sm text-slate-600 mb-4">Set up a new Irrevocable Life Insurance Trust</p>
                <Button
                  variant="outline"
                  onClick={() => navigate('/trusts/new')}
                >
                  Create Trust
                </Button>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="trusts">
            <Card>
              <CardHeader>
                <CardTitle>Trust Management</CardTitle>
                <CardDescription>View and manage all ILITs</CardDescription>
              </CardHeader>
              <CardContent>
                {/* Trust list would go here */}
                <div className="text-center py-8 text-slate-500">
                  Trust management interface
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="documents">
            <Card>
              <CardHeader>
                <CardTitle>Document Center</CardTitle>
                <CardDescription>Upload and manage trust documents</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="flex flex-col items-center py-8">
                  <FileUp className="h-12 w-12 text-slate-400 mb-4" />
                  <Button onClick={() => navigate('/documents/upload')}>
                    Upload Document
                  </Button>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="compliance">
            <Card>
              <CardHeader>
                <CardTitle>Compliance Center</CardTitle>
                <CardDescription>Monitor and maintain compliance</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="p-4 bg-green-50 rounded-lg">
                    <div className="flex items-center justify-between">
                      <div>
                        <h4 className="font-semibold">Overall Compliance Score</h4>
                        <p className="text-sm text-slate-600">Based on notice delivery and documentation</p>
                      </div>
                      <div className="text-3xl font-bold text-green-600">{stats.complianceScore}%</div>
                    </div>
                    <Progress value={stats.complianceScore} className="mt-3" />
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
};

export default Dashboard;